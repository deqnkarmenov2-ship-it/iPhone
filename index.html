<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BG РЕСТО</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="manifest" href="manifest.json"> 
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#158062">
    <meta name="application-name" content="BG РЕСТО">

    <style>
        /* ОСНОВНИ СТИЛОВЕ */
        html, body {
            height: 100%; 
            margin: 0;
            overflow: hidden; 
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .app-container {
            background-color: white;
            width: 100%;
            max-width: 375px;
            height: 100%; 
            border-radius: 0; 
            box-shadow: none; 
            display: flex;
            flex-direction: column;
            position: relative; 
        }
        .content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1; 
            overflow-y: auto; 
            transition: opacity 0.3s;
        }

        /* СТИЛ ЗА ГЛАВНАТА ИНСТРУКЦИЯ */
        .instruction {
            font-size: 24px; 
            font-weight: bold;
            color: black; 
            text-align: center;
            margin-bottom: 25px; 
            padding-top: 15px; 
        }
        
        /* СТИЛОВЕ ЗА ЗАКЛЮЧВАНЕ */
        .full-lock-overlay {
            position: absolute;
            top: 0; 
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.98);
            z-index: 990; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        .full-lock-overlay .lock-content {
            background-color: #f2f2f7;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* СТИЛОВЕ ЗА ВХОДНИ ПОЛЕТА */
        .cash-section {
            width: 100%;
            border-top: 1px solid #e0e0e0;
            margin-top: 15px; 
            padding-top: 10px;
            flex-shrink: 0;
        }
        .cash-section h3 {
            margin: 10px 0;
            font-size: 16px;
            color: #158062;
            text-align: center;
        }
        .cash-section label {
            display: block; 
            text-align: left; 
            font-size: 14px; 
            margin-bottom: 5px; 
            color: #555;
            padding-left: 5px;
        }
        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px; 
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            color: #333;
            outline: none;
            flex-shrink: 0;
        }
        input:focus {
            border-color: #158062;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* СТИЛОВЕ ЗА БУТОНИ */
        .btn-calc, .btn-calc-pink, .btn-reset { 
            background-color: #158062; 
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 15px; 
            box-sizing: border-box; 
            flex-shrink: 0;
        }
        .btn-calc:active, .btn-calc-pink:active {
            background-color: #0f5f49;
        }
        .btn-unlock-buy {
            background-color: #d93025 !important; 
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 15px; 
            margin-bottom: 0; 
            display: block;
            text-align: center;
            text-decoration: none;
            box-sizing: border-box; 
        }
        .lock-content .btn-calc {
            margin-top: 10px; 
            margin-bottom: 0; 
        }
        .btn-reset {
            background-color: #d93025; /* Червен цвят */
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 5px; 
            margin-bottom: 20px; 
            box-sizing: border-box;
            flex-shrink: 0;
        }

        /* СТИЛОВЕ ЗА РЕЗУЛТАТИ */
        .results {
            text-align: center;
            font-size: 20px;
            font-weight: 500;
            color: #000;
            flex-shrink: 0;
        }
        .results p {
            margin: 5px 0; 
            font-size: 20px; 
            font-weight: bold;
        }
        .results .total-bill {
            font-size: 14px; 
            margin-top: 10px; 
            color: #555;
            font-weight: normal;
        }
        .results .warning {
            color: orange;
            font-size: 16px;
            font-weight: 600;
            margin-top: 5px;
        }

        /* ----------------------------------------------------- */
        /* СТИЛОВЕ ЗА ИНЛАЙН ИНСТАЛАЦИОНЕН БАНЕР (PWA Prompt) */
        /* ----------------------------------------------------- */
        .install-prompt-modal {
            width: 100%;
            background-color: #158062;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-sizing: border-box;
            color: white;
            text-align: center;
            z-index: 10;
        }
        
        .prompt-content p {
            margin: 5px 0 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .prompt-content button {
            width: 48%; 
            margin: 5px 1% 0;
            display: inline-block;
            box-sizing: border-box;
            padding: 8px;
            font-size: 14px;
        }
        
        /* Специфични цветове за бутоните в банера: */
        #installPrompt #installButton {
            background-color: white; 
            color: #158062;
        }
        
        /* *** КОРЕКЦИЯ: Бутонът "Отказ" да е червен като .btn-reset *** */
        #installPrompt #dismissButton {
            background-color: #d93025; /* Червен фон */
            color: white;
            border: none;
            font-weight: bold;
        }
    </style>
</head>
<body onload="checkAndAutoReset(); loadCashLimits(); checkProStatus();">
    <div class="app-container">
        
        <div class="content" id="lockedContent">
            
            <div class="instruction">
                Въведи сметката и сумата,<br> с която е платено
            </div>
            
            <div id="installPrompt" class="install-prompt-modal" style="display: none;">
                <div class="prompt-content">
                    <p>Инсталирай приложението на телефона си за бърз достъп!</p>
                    <button id="installButton" class="btn-calc">Инсталирай</button>
                    <button id="dismissButton" class="btn-reset">ОТКАЗ</button>
                </div>
            </div>
            
            <input type="number" id="billEur" placeholder="Сметка в евро" step="0.01" inputmode="decimal">

            <input type="number" id="paidEur" placeholder="Платено в евро" step="0.01" inputmode="decimal">
            <input type="number" id="paidBgn" placeholder="Платено в лв" step="0.01" inputmode="decimal">

            <button class="btn-calc" onclick="calculateResto()">ИЗЧИСЛИ РЕСТО</button>

            <div class="results">
                <p>Връщаш €: <span id="resEur">0.00</span></p>
                <p>Връщаш лв: <span id="resBgn">0.00</span></p>
                <p class="total-bill">Обща сметка: <span id="totalBillDisplay">0.00</span> лв</p>
                <p class="warning" id="cashWarning"></p>
            </div>
            
            <div class="cash-section">
                <h3>Наличност в евро (за оптимизация)</h3>
                
                <label for="cashEur">Наличност в евро (€):</label>
                <input type="number" id="cashEur" placeholder="Въведи 0, ако нямаш евро" step="0.01" inputmode="decimal" oninput="saveCashLimit()">
            </div>
            
            <button class="btn-calc-pink" onclick="calculateResto()">ИЗЧИСЛИ РЕСТО</button>

            <button class="btn-reset" onclick="resetFields()">НУЛИРАНЕ</button>
        </div>
        
        <div class="full-lock-overlay" id="fullLockOverlay" style="display:none;">
            <div class="lock-content">
                
                <h3 style="font-size: 20px; font-weight: bold; color: #158062; margin-bottom: 15px; margin-top: 0;">BG РЕСТО калкулатор</h3>

                <a href="https://bgresto.gumroad.com/l/zrxcf?wanted=true" class="btn-unlock-buy" target="_blank" style="margin-top: 0; margin-bottom: 25px; background-color: #158062 !important;">
                    КУПИ ЗА 5.99 USD
                </a>
                
                <p style="font-size: 16px; margin: 0 0 25px 0; line-height: 1.4; color: black; font-weight: 500;">
                    Моля, въведете вашия **EMAIL** и **УНИКАЛЕН КОД**, получен след покупка.
                </p>
                
                <input type="email" id="userEmail" placeholder="ВЪВЕДЕТЕ EMAIL" style="margin-bottom: 10px;"/> 
                
                <input type="text" id="unlockKey" placeholder="ВЪВЕДЕТЕ ВАШИЯ КОД ТУК" style="margin-bottom: 15px;"/> 
                
                <button class="btn-calc btn-unlock-buy" onclick="unlockFeature()" style="margin-top: 10px; margin-bottom: 0;">АКТИВИРАЙ</button> 

            </div>
        </div>
    </div>
    
    <script>
    // --- ГЛОБАЛНИ КОНСТАНТИ ---
    const API_ENDPOINT = 'https://api.bgresto.online/api/unlock';
    const EURO_RATE = 1.95583; // Официален курс на EUR към BGN

    // Ключове за localStorage и Cookies
    const LS_UNLOCKED_STATUS = 'is_pro'; 
    const LS_UUID = 'device_uuid';
    const COOKIE_UUID = 'resto_uuid'; 
    const LS_INSTALL_DISMISSED = 'install_dismissed'; 

    // --- PWA & UI ЕЛЕМЕНТИ ---
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installButton = document.getElementById('installButton');
    const dismissButton = document.getElementById('dismissButton');
    
    // --- ФУНКЦИИ ЗА МОБИЛНА СЪВМЕСТИМОСТ (Запетая -> Точка) ---

    // 1. Функция за замяна на запетая с точка
    function formatDecimal(input) {
        // Заменя всички запетаи с точки
        input.value = input.value.replace(',', '.'); 
    }

    // 2. Функция за прикачване на събитието към входните полета
    function setupDecimalInputs() {
        // ИД-та на всички входни полета, които работят с десетични числа
        const decimalInputs = [
            document.getElementById('billEur'),
            document.getElementById('paidEur'),
            document.getElementById('paidBgn'),
            document.getElementById('cashEur')
        ];

        decimalInputs.forEach(input => {
            if (input) {
                // Прикачаме към събитие 'input'. Това се задейства при всяка промяна на стойността,
                // дори от мобилни клавиатури, и е по-добро от 'keyup'.
                input.addEventListener('input', () => {
                    formatDecimal(input);
                    // След форматирането, извикваме калкулацията
                    calculateResto(); 
                });
            }
        });
    }

    // --- PWA ЛОГИКА ---

    // PWA: Регистрация на Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => {
                    console.log('Service Worker: Registration successful.');
                })
                .catch(err => {
                    console.log('Service Worker: Registration failed.', err);
                });
        });
    }

    // PWA: Показване на инсталационния банер
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Показва банера, само ако потребителят е PRO
        if (localStorage.getItem(LS_UNLOCKED_STATUS) === 'true') {
            showPermanentInstallPrompt();
        }
    });

    // PWA: При инсталиране на приложението
    window.addEventListener('appinstalled', () => {
        if(installPrompt) installPrompt.style.display = 'none';
        deferredPrompt = null;
        localStorage.removeItem(LS_INSTALL_DISMISSED);
    });

    // PWA: Инсталиране чрез бутон
    if (installButton) {
        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                if(installPrompt) installPrompt.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choiceResult => {
                    deferredPrompt = null;
                });
            }
        });
    }

    // PWA: Отказ от инсталиране
    if (dismissButton) {
        dismissButton.addEventListener('click', () => {
            if(installPrompt) installPrompt.style.display = 'none';
            // Записваме, че потребителят е отказал
            localStorage.setItem(LS_INSTALL_DISMISSED, 'true');
        });
    }

    // --- COOKIE И UUID ФУНКЦИИ ---

    function setCookie(name, value, days) {
        let expires = '';
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = '; expires=' + date.toUTCString();
        }
        document.cookie = name + '=' + (value || '') + expires + '; path=/';
    }

    function getCookie(name) {
        const nameEQ = name + '=';
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function generateUUID() {
        // Стандартна генерация на UUID
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function getOrCreateUUID() {
        let uuid = localStorage.getItem(LS_UUID);
        if (!uuid) uuid = getCookie(COOKIE_UUID);
        if (!uuid) uuid = generateUUID();

        localStorage.setItem(LS_UUID, uuid);
        setCookie(COOKIE_UUID, uuid, 3650); // Set cookie for 10 years
        return uuid;
    }

    // --- PRO СТАТУС И ЗАКЛЮЧВАНЕ ---

    function showPermanentInstallPrompt() {
        if (deferredPrompt && installPrompt && localStorage.getItem(LS_INSTALL_DISMISSED) !== 'true') {
            installPrompt.style.display = 'block';
        }
    }

    function checkProStatus() {
        const fullLockOverlay = document.getElementById('fullLockOverlay');

        // Логика за отключен (PRO) статус
        if (localStorage.getItem(LS_UNLOCKED_STATUS) === 'true') {
            if (fullLockOverlay) fullLockOverlay.style.display = 'none';
            showPermanentInstallPrompt();
            
            // Премахване на ограниченията и скритите елементи
            const cashLabel = document.querySelector('.cash-section label');
            const cashInput = document.getElementById('cashEur');
            
            if (cashLabel) {
                cashLabel.style.color = '#0f5f49'; 
                cashLabel.style.opacity = '1'; 
            }
            if (cashInput) {
                cashInput.style.opacity = '1'; 
            }
            return;
        }

        // Логика за заключен статус
        if (fullLockOverlay) fullLockOverlay.style.display = 'flex';
        
        // Функцията showLimitMessage се дефинира тук, за да има достъп до променливите
        function showLimitMessage() {
            const warningElement = document.getElementById('cashWarning');
            const cashInput = document.getElementById('cashEur');
            let cashValue = parseFloat(cashInput.value) || 0;

            const FREE_VERSION_LIMIT = 58; // €58.00
            
            if (cashInput && warningElement) {
                if (cashValue >= FREE_VERSION_LIMIT) { 
                    warningElement.style.color = 'orange';
                    warningElement.textContent = `Ограничение: ${cashValue.toFixed(2)}€. Макс. ${FREE_VERSION_LIMIT.toFixed(2)}€ за безплатната версия.`;
                    cashInput.style.color = 'red';
                } else {
                    warningElement.textContent = '';
                    cashInput.style.color = 'black';
                }
            }
        }
        
        // Проверяваме лимита при зареждане на DOM
        showLimitMessage(); 

        // Прикачваме showLimitMessage към input събитията на cashEur, за да работи веднага.
        const cashEurInput = document.getElementById('cashEur');
        if (cashEurInput) {
             cashEurInput.addEventListener('input', showLimitMessage);
        }
    }

    function unlockFeature() {
        const userEmail = document.getElementById('userEmail').value.trim();
        const unlockKey = document.getElementById('unlockKey').value.trim();
        
        if (userEmail.length === 0 || unlockKey.length === 0) {
            alert('Моля, попълнете и двете полета.');
            return;
        }

        const unlockButton = document.querySelector('.btn-unlock-buy');
        if (unlockButton) unlockButton.textContent = 'ПРОВЕРКА НА КОДА...';

        const uuid = getOrCreateUUID();
        // URL за проверка, включваща email, код и уникален ключ (UUID)
        const url = `${API_ENDPOINT}?email=${encodeURIComponent(userEmail)}&code=${encodeURIComponent(unlockKey)}&key=${uuid}_WEB`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const warningElement = document.querySelector('.btn-unlock-buy'); 

                if (data.success) {
                    // УСПЕШНО ОТКЛЮЧВАНЕ
                    localStorage.setItem(LS_UNLOCKED_STATUS, 'true');
                    const fullLockOverlay = document.getElementById('fullLockOverlay');
                    if(fullLockOverlay) fullLockOverlay.style.display = 'none';
                    if (warningElement) warningElement.style.backgroundColor = '#3c763d'; // Зелено за успех
                    alert(data.message);
                    checkProStatus(); 
                } else {
                    // ГРЕШКА
                    if (warningElement) {
                        warningElement.style.backgroundColor = 'red';
                        warningElement.textContent = data.message + '. Опитайте отново.';
                    }
                }
            })
            .catch(error => {
                console.error(error);
                alert('Грешка при комуникация със сървъра. Неуспешна проверка на ключа. Моля, опитайте отново по-късно.');

                const warningElement = document.querySelector('.btn-unlock-buy'); 
                if (warningElement) {
                    warningElement.style.backgroundColor = 'red';
                    warningElement.textContent = 'ГРЕШКА. Опитайте отново.';
                }
            });
    }

    // --- ЛОГИКА НА КАЛКУЛАТОРА ---

    function calculateResto() {
        // Взимане на стойностите. Използваме 0.0, ако полето е празно.
        const billEur = parseFloat(document.getElementById('billEur').value) || 0.0;
        const paidEur = parseFloat(document.getElementById('paidEur').value) || 0.0;
        const paidBgn = parseFloat(document.getElementById('paidBgn').value) || 0.0;
        const cashEurLimit = parseFloat(document.getElementById('cashEur').value) || 0.0;

        const resEurElement = document.getElementById('resEur');
        const resBgnElement = document.getElementById('resBgn');
        const totalBillDisplayElement = document.getElementById('totalBillDisplay');
        const cashWarningElement = document.getElementById('cashWarning');
        
        // Нулиране при празни полета
        if (billEur <= 0.0 && paidEur <= 0.0 && paidBgn <= 0.0) {
            if(resEurElement) resEurElement.textContent = '0.00';
            if(resBgnElement) resBgnElement.textContent = '0.00';
            if(totalBillDisplayElement) totalBillDisplayElement.textContent = '0.00';
            if(cashWarningElement) cashWarningElement.textContent = '';
            return;
        }

        // Обща сметка в BGN (за показване)
        const totalBillBgn = billEur * EURO_RATE;
        if(totalBillDisplayElement) totalBillDisplayElement.textContent = totalBillBgn.toFixed(2);
        
        let restoEur = 0.0;
        let restoBgn = 0.0;
        
        // Скриваме предишни предупреждения
        if(cashWarningElement) cashWarningElement.textContent = '';

        // Обща платена сума в BGN
        const totalPaidBgn = (paidEur * EURO_RATE) + paidBgn;
        
        // 1. Изчисление на рестото в EUR
        if (paidEur > 0.0) {
            restoEur = paidEur - billEur;
            // Ако рестото е отрицателно, значи не е платено достатъчно в EUR
            if (restoEur < 0.0) restoEur = 0.0; 
        }
        
        // Обща промяна в BGN
        let totalChangeBgn = totalPaidBgn - totalBillBgn;
        totalChangeBgn = parseFloat(totalChangeBgn.toFixed(2));
        
        // Ако общата промяна е отрицателна (не е платено достатъчно)
        if (totalChangeBgn < 0.0) {
            restoEur = 0.0;
            totalChangeBgn = 0.0;
        }
        
        // --- PRO Limit Check (за сметки над 58€) ---
        const PRO_LIMIT_EUR = 58; 
        if (localStorage.getItem(LS_UNLOCKED_STATUS) !== 'true' && billEur > PRO_LIMIT_EUR && paidEur > 0.0) {
            if (cashWarningElement) {
                cashWarningElement.style.color = 'red';
                cashWarningElement.textContent = 'Моля, активирайте PRO версията за сметки над ' + PRO_LIMIT_EUR.toFixed(2) + '€';
            }
            if(resEurElement) resEurElement.textContent = '0.00';
            if(resBgnElement) resBgnElement.textContent = '0.00';
            if(totalBillDisplayElement) totalBillDisplayElement.textContent = '0.00';
            return;
        }
        
        // --- Оптимизация за Наличност в EUR (Cash Limit) ---
        // Тази логика се изпълнява, само ако имаме положително ресто в EUR
        if (restoEur > 0.0 && cashEurLimit >= 0.0) { // cashEurLimit може да е 0.0
            
            if (restoEur > cashEurLimit) {
                // Разликата в EUR, която не можем да върнем:
                const diffEur = restoEur - cashEurLimit;
                // Превръщаме разликата в BGN, която да добавим към рестото в BGN
                const extraBgnToPay = diffEur * EURO_RATE;
                
                // Рестото в EUR е равно на наличността
                restoEur = cashEurLimit;
                
                // Рестото в BGN: общата промяна в BGN минус това, което върнахме в EUR
                restoBgn = totalChangeBgn - (restoEur * EURO_RATE);
                restoBgn = parseFloat(restoBgn.toFixed(2));

                // Показване на предупреждение
                if (cashWarningElement) {
                    cashWarningElement.style.color = 'orange';
                    cashWarningElement.textContent = `Имаш само ${cashEurLimit.toFixed(2)}€ наличност. Връщаш ${restoEur.toFixed(2)}€ и ${restoBgn.toFixed(2)}лв.`;
                }

            } else {
                 // Ако имаме достатъчно наличност в EUR, връщаме цялото ресто в EUR.
                 // Рестото в BGN е само частта от BGN плащането
                 if (paidBgn > 0) {
                    restoBgn = totalChangeBgn - (restoEur * EURO_RATE);
                    restoBgn = parseFloat(restoBgn.toFixed(2));
                 } else {
                     restoBgn = 0.0; // Ако плащането е само в EUR, рестото в BGN е 0
                 }
            }
            
        } else {
            // Ако няма плащане в EUR (paidEur === 0.0), цялото ресто е в BGN
            if (paidEur === 0.0) {
                restoEur = 0.0;
                restoBgn = totalChangeBgn;
            } else {
                // Ако restoEur е 0.0 или отрицателно, рестото е 0.00/0.00
                restoEur = 0.0;
                restoBgn = 0.0;
            }
        }
        
        // Финален резултат
        if(resEurElement) resEurElement.textContent = restoEur.toFixed(2);
        if(resBgnElement) resBgnElement.textContent = restoBgn.toFixed(2);
    }

    // --- ПОМОЩНИ ФУНКЦИИ ---

    function resetFields() {
        const billEur = document.getElementById('billEur');
        const paidEur = document.getElementById('paidEur');
        const paidBgn = document.getElementById('paidBgn');

        if(billEur) billEur.value = '';
        if(paidEur) paidEur.value = '';
        if(paidBgn) paidBgn.value = '';
        
        // Нулираме и показването
        document.getElementById('resEur').textContent = '0.00';
        document.getElementById('resBgn').textContent = '0.00';
        document.getElementById('totalBillDisplay').textContent = '0.00';
        document.getElementById('cashWarning').textContent = '';
    }

    function loadCashLimits() {
        let cashEurValue = localStorage.getItem('resto_cashEur');
        const cashEurInput = document.getElementById('cashEur');
        
        if (cashEurValue) {
            cashEurValue = parseFloat(cashEurValue);
        }
        
        if(cashEurInput) cashEurInput.value = (cashEurValue || 0.00).toFixed(2);
    }

    function saveCashLimit() {
        let cashEurValue = document.getElementById('cashEur').value;
        localStorage.setItem('resto_cashEur', cashEurValue);
        // Добавяме и извикване на проверката на PRO статуса, за да се опресни лимитът
        checkProStatus();
    }
    
    function checkAndAutoReset() {
        let lastResetTime = localStorage.getItem('resto_lastResetTime');
        
        if (!lastResetTime) {
            localStorage.setItem('resto_lastResetTime', new Date().getTime());
        } else {
            const currentTime = new Date();
            const difference = currentTime.getTime() - lastResetTime;
            
            // Ако са минали повече от 5 минути (300 000 милисекунди)
            const FIVE_MINUTES_MS = 300000;
            if (difference > FIVE_MINUTES_MS) {
                resetFields();
                localStorage.setItem('resto_lastResetTime', currentTime.getTime());
            }
        }
        
        loadCashLimits();
    }
    
    // --- ИНИЦИАЛИЗАЦИЯ (Изпълнява се при зареждане на DOM) ---
    
    // Използваме 'DOMContentLoaded' за да гарантираме, че всички HTML елементи са налични
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Настройва обработката на запетая/точка за всички полета
        setupDecimalInputs(); 
        
        // 2. Проверява за автоматично нулиране и зарежда лимита
        checkAndAutoReset();
        
        // 3. Проверява PRO статуса и активира/деактивира заключването
        checkProStatus(); 
    });

</script>
</body>
</html>
